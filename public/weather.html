<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Forecast</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

        // Icon Wrapper Component
        const Icon = ({ name, size = 24, className, ...props }) => {
            useEffect(() => {
                lucide.createIcons();
            }, [name]);

            return <i data-lucide={name} width={size} height={size} className={className} {...props}></i>;
        };

        // Map Lucide React component names to Lucide icon names (kebab-case)
        const Snowflake = (props) => <Icon name="snowflake" {...props} />;
        const Droplets = (props) => <Icon name="droplets" {...props} />;
        const Thermometer = (props) => <Icon name="thermometer" {...props} />;
        const Wind = (props) => <Icon name="wind" {...props} />;
        const Sunrise = (props) => <Icon name="sunrise" {...props} />;
        const Sunset = (props) => <Icon name="sunset" {...props} />;
        const Clock = (props) => <Icon name="clock" {...props} />;
        const Search = (props) => <Icon name="search" {...props} />;
        const MapPin = (props) => <Icon name="map-pin" {...props} />;
        const Calendar = (props) => <Icon name="calendar" {...props} />;
        const History = (props) => <Icon name="history" {...props} />;
        const RotateCcw = (props) => <Icon name="rotate-ccw" {...props} />;
        const ChevronLeft = (props) => <Icon name="chevron-left" {...props} />;
        const ChevronRight = (props) => <Icon name="chevron-right" {...props} />;
        const BarChart3 = (props) => <Icon name="bar-chart-3" {...props} />;
        const X = (props) => <Icon name="x" {...props} />;
        const LineChartIcon = (props) => <Icon name="line-chart" {...props} />;

        // --- Configuration & Helpers ---

        const DEFAULT_LOCATIONS = [
            { name: 'Parker, CO', lat: 39.5186, lon: -104.7614 },
            { name: 'Uehling, NE', lat: 41.7336, lon: -96.5028 },
            { name: 'San Diego, CA', lat: 32.7157, lon: -117.1611 },
            { name: 'Chicago, IL', lat: 41.8781, lon: -87.6298 },
            { name: 'Rochester, NY', lat: 43.1566, lon: -77.6088 },
            { name: 'Clayton, NY', lat: 44.2395, lon: -76.0858 },
        ];

        const DAYS_OF_WEEK = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        // Generate years from 1990 to next year (extended range for historical data)
        const currentYear = new Date().getFullYear();
        const YEARS = Array.from({ length: currentYear - 1990 + 2 }, (_, i) => currentYear + 1 - i);

        // Helper to format dates for API (YYYY-MM-DD)
        const formatDateAPI = (date) => {
            return date.toISOString().split('T')[0];
        };

        // Helper to format ISO time strings to 'h:mm AM/PM'
        const formatTime = (isoString) => {
            if (!isoString || !isoString.includes('T')) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        };

        // Helper to format duration in seconds to 'Hh Mm'
        const formatDuration = (seconds) => {
            if (typeof seconds !== 'number' || seconds < 0) return 'N/A';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        };

        // --- Components ---

        function App() {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [locations, setLocations] = useState(DEFAULT_LOCATIONS);
            const [location, setLocation] = useState(DEFAULT_LOCATIONS[0]);
            const [weatherData, setWeatherData] = useState({});
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            
            // Search & History State
            const [searchQuery, setSearchQuery] = useState('');
            const [isSearching, setIsSearching] = useState(false);
            const [historicalAverages, setHistoricalAverages] = useState(null);
            const [loadingHistory, setLoadingHistory] = useState(false);

            // Grid View State
            const [showHistoryGrid, setShowHistoryGrid] = useState(false);
            const [gridData, setGridData] = useState(null);
            const [loadingGrid, setLoadingGrid] = useState(false);
            const [gridMetric, setGridMetric] = useState('temp'); // 'temp', 'precip', 'snow'

            // Graph View State
            const [showGraph, setShowGraph] = useState(false);
            const [graphData, setGraphData] = useState(null); // { snow: [], temp: [], daylight: [] }
            const [loadingGraph, setLoadingGraph] = useState(false);
            const [graphYears, setGraphYears] = useState([]);
            const [visibleYears, setVisibleYears] = useState({});
            const [graphMetric, setGraphMetric] = useState('snow'); // 'snow', 'temp', 'daylight'
            const [visibleMonths, setVisibleMonths] = useState(
                Object.fromEntries(Array.from({ length: 12 }, (_, i) => [i, true]))
            );

            // Calendar Data Visibility Toggles
            const [showSnowfall, setShowSnowfall] = useState(true);
            const [showPrecipitation, setShowPrecipitation] = useState(true);

            // Mobile detection
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);

            // Derived state for calendar generation
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayOfMonth = new Date(year, month, 1).getDay();

            // --- Actions ---

            const handleMonthChange = (increment) => {
                const newDate = new Date(year, month + increment, 1);
                setCurrentDate(newDate);
            };

            const handleYearChange = (increment) => {
                const newDate = new Date(year + increment, month, 1);
                setCurrentDate(newDate);
            };

            const handleJumpToToday = () => {
                const today = new Date();
                setCurrentDate(today);
                setSelectedDate(today);
            };

            const handleCurrentLocation = () => {
                if (navigator.geolocation) {
                setLoading(true);
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                    const newLoc = {
                        name: 'My Location',
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };
                    setLocations(prev => [...prev, newLoc]);
                    setLocation(newLoc);
                    setLoading(false);
                    },
                    (err) => {
                    setError('Location access denied');
                    setLoading(false);
                    }
                );
                } else {
                setError('Geolocation not supported');
                }
            };

            const handleSearchLocation = async (e) => {
                e.preventDefault();
                if (!searchQuery.trim()) return;

                setIsSearching(true);
                try {
                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(searchQuery)}&count=1&language=en&format=json`);
                const data = await res.json();
                
                if (data.results && data.results.length > 0) {
                    const result = data.results[0];
                    const newLoc = {
                    name: `${result.name}, ${result.admin1 || result.country_code}`,
                    lat: result.latitude,
                    lon: result.longitude
                    };
                    setLocations(prev => [...prev, newLoc]);
                    setLocation(newLoc);
                    setSearchQuery('');
                } else {
                    setError('Location not found');
                }
                } catch (err) {
                setError('Search failed');
                } finally {
                setIsSearching(false);
                }
            };

            const fetchHistoricalComparison = async () => {
                setLoadingHistory(true);
                setHistoricalAverages(null);
                
                try {
                // Fetch last 10 years for the selected date
                const month = selectedDate.getMonth() + 1;
                const day = selectedDate.getDate();
                const currentYear = new Date().getFullYear();
                
                const yearsToFetch = [1, 3, 10]; // 1 year ago, 3 years ago, 10 years ago
                const historyData = {};

                await Promise.all(yearsToFetch.map(async (yearsAgo) => {
                    const targetYear = currentYear - yearsAgo;
                    const dateStr = `${targetYear}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                    
                    const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${location.lat}&longitude=${location.lon}&start_date=${dateStr}&end_date=${dateStr}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,snowfall_sum&temperature_unit=fahrenheit&precipitation_unit=inch&timezone=auto`;
                    
                    const res = await fetch(url);
                    const data = await res.json();
                    
                    if (data.daily && data.daily.time && data.daily.time.length > 0) {
                    historyData[yearsAgo] = {
                        year: targetYear,
                        tempMax: data.daily.temperature_2m_max[0],
                        tempMin: data.daily.temperature_2m_min[0],
                        precip: data.daily.precipitation_sum[0],
                        snow: data.daily.snowfall_sum[0]
                    };
                    }
                }));

                setHistoricalAverages(historyData);
                } catch (err) {
                console.error('Failed to fetch history', err);
                } finally {
                setLoadingHistory(false);
                }
            };

            const fetchGridHistory = async () => {
                if (gridData) return; // Don't refetch if we have data (unless location changes, handled by useEffect clearing)
                
                setLoadingGrid(true);
                try {
                const currentYear = new Date().getFullYear();
                const years = [currentYear, currentYear - 1, currentYear - 2, currentYear - 3];
                const startDate = `${years[years.length - 1]}-01-01`;
                
                // Clamp endDate to yesterday to avoid future data errors in Archive API
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 5); // Archive API has ~5 day delay
                const yesterdayStr = formatDateAPI(yesterday);
                const endDate = yesterdayStr;
                
                // Fetch 4 years of daily data
                const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${location.lat}&longitude=${location.lon}&start_date=${startDate}&end_date=${endDate}&daily=temperature_2m_mean,precipitation_sum,snowfall_sum&temperature_unit=fahrenheit&precipitation_unit=inch&timezone=auto`;
                
                console.log('Fetching grid history:', url);
                const res = await fetch(url);
                const data = await res.json();
                
                if (!data.daily) throw new Error('No data');

                // Process data into monthly aggregates
                const processed = {};
                // Initialize structure: { monthIndex: { year: { temp: 0, precip: 0, snow: 0, count: 0 } } }
                
                data.daily.time.forEach((dateStr, i) => {
                    const date = new Date(dateStr);
                    const m = date.getMonth();
                    const y = date.getFullYear();
                    
                    if (!processed[m]) processed[m] = {};
                    if (!processed[m][y]) processed[m][y] = { tempSum: 0, precip: 0, snow: 0, count: 0 };
                    
                    const d = processed[m][y];
                    if (data.daily.temperature_2m_mean[i] !== null) {
                    d.tempSum += data.daily.temperature_2m_mean[i];
                    d.count++;
                    }
                    d.precip += data.daily.precipitation_sum[i] || 0;
                    d.snow += data.daily.snowfall_sum[i] || 0;
                });

                setGridData(processed);
                } catch (err) {
                console.error('Grid fetch failed', err);
                } finally {
                setLoadingGrid(false);
                }
            };

            // Clear grid data when location changes
            useEffect(() => {
                setGridData(null);
                setGraphData(null);
            }, [location]);

            // Handle window resize for mobile detection
            useEffect(() => {
                const handleResize = () => {
                    setIsMobile(window.innerWidth < 768);
                };
                
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const fetchGraphData = async () => {
                if (graphData) return;
                
                setLoadingGraph(true);
                try {
                const currentYear = new Date().getFullYear();
                const years = [currentYear, currentYear - 1, currentYear - 2, currentYear - 3, currentYear - 4];
                setGraphYears(years);
                
                // Initialize visible years (all true by default)
                const initialVisible = {};
                years.forEach(y => initialVisible[y] = true);
                setVisibleYears(initialVisible);

                const startDate = `${years[years.length - 1]}-01-01`;
                
                // Clamp endDate to yesterday
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 5);
                const endDate = formatDateAPI(yesterday);
                
                const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${location.lat}&longitude=${location.lon}&start_date=${startDate}&end_date=${endDate}&daily=snowfall_sum,temperature_2m_max,daylight_duration&temperature_unit=fahrenheit&precipitation_unit=inch&timezone=auto`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (!data.daily) throw new Error('No data');

                // Create base arrays for each metric
                const createBaseArray = () => {
                    const arr = [];
                    const tempDate = new Date(2020, 0, 1); 
                    for (let i = 0; i < 366; i++) {
                    const m = tempDate.getMonth();
                    const d = tempDate.getDate();
                    const label = `${MONTHS[m].substring(0, 3)} ${d}`;
                    
                    const dayObj = {
                        label: label,
                        month: m,
                        day: d
                    };
                    years.forEach(y => dayObj[y] = null);
                    arr.push(dayObj);
                    tempDate.setDate(tempDate.getDate() + 1);
                    }
                    return arr;
                };

                const snowData = createBaseArray();
                const tempData = createBaseArray();
                const daylightData = createBaseArray();

                // Fill in data
                data.daily.time.forEach((dateStr, i) => {
                    const [yStr, mStr, dStr] = dateStr.split('-');
                    const y = parseInt(yStr);
                    const m = parseInt(mStr) - 1;
                    const d = parseInt(dStr);
                    
                    if (!years.includes(y)) return;

                    const dayIndex = snowData.findIndex(item => item.month === m && item.day === d);

                    if (dayIndex !== -1) {
                        snowData[dayIndex][y] = data.daily.snowfall_sum[i];
                        tempData[dayIndex][y] = data.daily.temperature_2m_max[i];
                        // Convert seconds to hours
                        daylightData[dayIndex][y] = data.daily.daylight_duration[i] ? (data.daily.daylight_duration[i] / 3600) : null;
                    }
                });

                setGraphData({
                    snow: snowData,
                    temp: tempData,
                    daylight: daylightData
                });

                } catch (err) {
                console.error('Graph fetch failed', err);
                } finally {
                setLoadingGraph(false);
                }
            };

            // --- Data Fetching ---

            useEffect(() => {
                const fetchData = async () => {
                setLoading(true);
                setError(null);
                
                try {
                    const startDate = new Date(year, month, 1);
                    const endDate = new Date(year, month + 1, 0); 

                    const startStr = formatDateAPI(startDate);
                    
                    // Clamp end date for forecast API to avoid "out of range" errors
                    // Forecast API usually supports up to 14-16 days.
                    // If we are in the current month, we might be asking for dates too far in the future.
                    
                    let endStr = formatDateAPI(endDate);
                    const today = new Date();
                    const maxForecastDate = new Date();
                    maxForecastDate.setDate(today.getDate() + 14); // Safe margin for forecast

                    let url = '';
                    const tenDaysAgo = new Date();
                    tenDaysAgo.setDate(tenDaysAgo.getDate() - 10);
                    
                    const isHistorical = endDate < tenDaysAgo;
                    
                    // Params for imperial units, including sun/daylight data
                    const params = `&daily=precipitation_sum,snowfall_sum,temperature_2m_max,temperature_2m_min,wind_speed_10m_max,sunrise,sunset,daylight_duration&temperature_unit=fahrenheit&precipitation_unit=inch&wind_speed_unit=mph&timezone=auto`;

                    if (isHistorical) {
                        url = `https://archive-api.open-meteo.com/v1/archive?latitude=${location.lat}&longitude=${location.lon}&start_date=${startStr}&end_date=${endStr}${params}`;
                    } else {
                        // If using forecast API, ensure we don't ask for dates too far in the future
                        if (endDate > maxForecastDate) {
                            endStr = formatDateAPI(maxForecastDate);
                        }
                        url = `https://api.open-meteo.com/v1/forecast?latitude=${location.lat}&longitude=${location.lon}&start_date=${startStr}&end_date=${endStr}${params}`;
                    }

                    console.log('Fetching calendar data:', url);
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Weather data unavailable');
                    const data = await response.json();

                    const processed = {};
                    if (data.daily && data.daily.time) {
                    data.daily.time.forEach((time, index) => {
                        processed[time] = {
                        precipitation: data.daily.precipitation_sum[index],
                        snowfall: data.daily.snowfall_sum[index],
                        tempMax: data.daily.temperature_2m_max[index],
                        tempMin: data.daily.temperature_2m_min[index],
                        windSpeed: data.daily.wind_speed_10m_max[index],
                        sunrise: data.daily.sunrise[index],
                        sunset: data.daily.sunset[index],
                        daylightDuration: data.daily.daylight_duration[index],
                        };
                    });
                    }

                    setWeatherData(processed);
                } catch (err) {
                    setError(err.message || 'Failed to fetch data');
                    setWeatherData({});
                } finally {
                    setLoading(false);
                }
                };

                fetchData();
            }, [year, month, location]);

            // --- Render Helpers ---

            const renderCalendarDays = () => {
                const days = [];
                
                // Empty cells before month starts
                for (let i = 0; i < firstDayOfMonth; i++) {
                days.push(<div key={`empty-${i}`} className="aspect-square"></div>);
                }

                // Days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = formatDateAPI(date);
                const isSelected = dateStr === formatDateAPI(selectedDate);
                const data = weatherData[dateStr];

                days.push(
                    <button
                    key={day}
                    onClick={() => setSelectedDate(date)}
                    className={`
                        aspect-square rounded-lg p-1 md:p-2 text-xs md:text-sm font-medium transition-colors flex flex-col items-center justify-start
                        ${isSelected ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'}
                        ${data?.precipitation > 0 || data?.snowfall > 0 ? 'ring-1 md:ring-2 ring-blue-400' : ''}
                    `}
                    >
                    <div>{day}</div>
                    {data && (
                        <div className="text-[10px] md:text-xs mt-0.5 md:mt-1 leading-tight">
                        {showSnowfall && data.snowfall > 0 && <div className="text-blue-600 font-bold">‚ùÑ {data.snowfall}"</div>}
                        {showPrecipitation && data.precipitation > 0 && data.snowfall === 0 && <div className="text-blue-500 font-bold">üíß {data.precipitation}"</div>}
                        </div>
                    )}
                    </button>
                );
                }

                return days;
            };

            const selectedDateStr = formatDateAPI(selectedDate);
            const selectedData = weatherData[selectedDateStr];

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-400 to-blue-600 p-4 md:p-8">
                <div className="max-w-6xl mx-auto">
                    {/* Header */}
                    <div className="mb-6 md:mb-8">
                    <h1 className="text-2xl md:text-4xl font-bold text-white mb-2">Weather Forecast</h1>
                    <p className="text-blue-100 text-sm md:text-base">Historical and predicted weather data</p>
                    </div>

                    {/* Controls */}
                    <div className="bg-white rounded-lg shadow-lg p-4 md:p-6 mb-6 md:mb-8">
                    <div className="flex flex-col md:grid md:grid-cols-2 gap-6">
                        {/* Location Selector & Search */}
                        <div className="space-y-4">
                        <div className="flex gap-2">
                            <div className="flex-1">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Location</label>
                            <select
                                value={locations.indexOf(location)}
                                onChange={(e) => setLocation(locations[parseInt(e.target.value)])}
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            >
                                {locations.map((loc, i) => (
                                <option key={i} value={i}>{loc.name}</option>
                                ))}
                            </select>
                            </div>
                            <div className="flex items-end">
                            <button
                                onClick={handleCurrentLocation}
                                className="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors"
                                title="Use Current Location"
                            >
                                <MapPin size={24} />
                            </button>
                            </div>
                        </div>

                        <form onSubmit={handleSearchLocation} className="flex gap-2">
                            <input
                            type="text"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            placeholder="Search city..."
                            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                            <button
                            type="submit"
                            disabled={isSearching}
                            className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50"
                            >
                            {isSearching ? <div className="animate-spin">‚åõ</div> : <Search size={20} />}
                            </button>
                        </form>
                        </div>

                        {/* Month/Year Selector & Tools */}
                        <div className="space-y-4">
                        {/* Month Navigation */}
                        <div className="flex gap-2 items-end">
                            <button 
                            onClick={() => handleMonthChange(-1)}
                            className="p-2 hover:bg-gray-100 rounded-lg transition-colors flex-shrink-0"
                            title="Previous Month"
                            >
                            <ChevronLeft size={20} />
                            </button>
                            
                            <div className="flex-1">
                                <label className="block text-xs md:text-sm font-medium text-gray-700 mb-1 md:mb-2">Month</label>
                                <select
                                value={month}
                                onChange={(e) => setCurrentDate(new Date(year, parseInt(e.target.value), 1))}
                                className="w-full px-2 md:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                                >
                                {MONTHS.map((m, i) => (
                                    <option key={i} value={i}>{m}</option>
                                ))}
                                </select>
                            </div>

                            <button 
                            onClick={() => handleMonthChange(1)}
                            className="p-2 hover:bg-gray-100 rounded-lg transition-colors flex-shrink-0"
                            title="Next Month"
                            >
                            <ChevronRight size={20} />
                            </button>
                        </div>

                        {/* Year Navigation */}
                        <div className="flex gap-2 items-end">
                            <button 
                            onClick={() => handleYearChange(-1)}
                            className="p-2 hover:bg-gray-100 rounded-lg transition-colors flex-shrink-0"
                            title="Previous Year"
                            >
                            <ChevronLeft size={20} />
                            </button>
                            
                            <div className="flex-1">
                                <label className="block text-xs md:text-sm font-medium text-gray-700 mb-1 md:mb-2">Year</label>
                                <select
                                value={year}
                                onChange={(e) => setCurrentDate(new Date(parseInt(e.target.value), month, 1))}
                                className="w-full px-2 md:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                                >
                                {YEARS.map((y) => (
                                    <option key={y} value={y}>{y}</option>
                                ))}
                                </select>
                            </div>

                            <button 
                            onClick={() => handleYearChange(1)}
                            className="p-2 hover:bg-gray-100 rounded-lg transition-colors flex-shrink-0"
                            title="Next Year"
                            >
                            <ChevronRight size={20} />
                            </button>
                        </div>
                        
                        <div className="flex flex-col md:flex-row justify-end gap-2">
                            <button
                            onClick={() => {
                                setShowGraph(true);
                                fetchGraphData();
                            }}
                            className="flex items-center justify-center gap-2 px-4 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition-colors text-sm md:text-base"
                            >
                            <LineChartIcon size={18} />
                            Graph View
                            </button>
                            <button
                            onClick={() => {
                                setShowHistoryGrid(true);
                                fetchGridHistory();
                            }}
                            className="flex items-center justify-center gap-2 px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors text-sm md:text-base"
                            >
                            <BarChart3 size={18} />
                            History Grid
                            </button>
                            <button
                            onClick={handleJumpToToday}
                            className="flex items-center justify-center gap-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm md:text-base"
                            >
                            <RotateCcw size={18} />
                            Jump to Today
                            </button>
                        </div>
                        </div>
                    </div>
                    </div>

                    {/* History Grid Modal */}
                    {showHistoryGrid && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col m-4">
                        <div className="p-4 md:p-6 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                            <div>
                            <h2 className="text-xl md:text-2xl font-bold text-gray-800">Historical Analysis</h2>
                            <p className="text-gray-600 text-xs md:text-sm">{location.name}</p>
                            </div>
                            <button 
                            onClick={() => setShowHistoryGrid(false)}
                            className="p-2 hover:bg-gray-200 rounded-full transition-colors"
                            >
                            <X size={24} />
                            </button>
                        </div>
                        
                        <div className="p-4 md:p-6 overflow-auto flex-1">
                            <div className="flex flex-wrap gap-2 md:gap-4 mb-4 md:mb-6">
                            <button
                                onClick={() => setGridMetric('temp')}
                                className={`px-3 py-1.5 md:px-4 md:py-2 text-sm md:text-base rounded-lg font-medium transition-colors ${gridMetric === 'temp' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                            >
                                Avg Temperature
                            </button>
                            <button
                                onClick={() => setGridMetric('precip')}
                                className={`px-3 py-1.5 md:px-4 md:py-2 text-sm md:text-base rounded-lg font-medium transition-colors ${gridMetric === 'precip' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                            >
                                Total Precipitation
                            </button>
                            <button
                                onClick={() => setGridMetric('snow')}
                                className={`px-3 py-1.5 md:px-4 md:py-2 text-sm md:text-base rounded-lg font-medium transition-colors ${gridMetric === 'snow' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                            >
                                Total Snowfall
                            </button>
                            </div>

                            {loadingGrid ? (
                            <div className="flex justify-center py-12">
                                <div className="animate-spin text-4xl">‚åõ</div>
                            </div>
                            ) : gridData ? (
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                    <th className="px-6 py-3">Month</th>
                                    <th className="px-6 py-3">This Year ({new Date().getFullYear()})</th>
                                    <th className="px-6 py-3">Last Year ({new Date().getFullYear() - 1})</th>
                                    <th className="px-6 py-3">2 Years Ago ({new Date().getFullYear() - 2})</th>
                                    <th className="px-6 py-3">3 Years Ago ({new Date().getFullYear() - 3})</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {MONTHS.map((monthName, mIndex) => {
                                    const currentYear = new Date().getFullYear();
                                    return (
                                        <tr key={monthName} className="bg-white border-b hover:bg-gray-50">
                                        <td className="px-6 py-4 font-medium text-gray-900">{monthName}</td>
                                        {[0, 1, 2, 3].map(offset => {
                                            const y = currentYear - offset;
                                            const d = gridData[mIndex]?.[y];
                                            let val = '-';
                                            if (d) {
                                            if (gridMetric === 'temp') val = d.count ? (d.tempSum / d.count).toFixed(1) + '¬∞F' : '-';
                                            else if (gridMetric === 'precip') val = d.precip.toFixed(2) + '"';
                                            else if (gridMetric === 'snow') val = d.snow.toFixed(1) + '"';
                                            }
                                            return (
                                            <td key={offset} className="px-6 py-4">{val}</td>
                                            );
                                        })}
                                        </tr>
                                    );
                                    })}
                                </tbody>
                                </table>
                            </div>
                            ) : (
                            <p className="text-center text-gray-500">No data available</p>
                            )}
                        </div>
                        </div>
                    </div>
                    )}

                    {/* Graph View Modal */}
                    {showGraph && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col m-4">
                        <div className="p-4 md:p-6 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                            <div>
                            <h2 className="text-xl md:text-2xl font-bold text-gray-800">Historical Trends</h2>
                            <p className="text-gray-600 text-xs md:text-sm">{location.name} - Multi-Year Comparison</p>
                            </div>
                            <button 
                            onClick={() => setShowGraph(false)}
                            className="p-2 hover:bg-gray-200 rounded-full transition-colors"
                            >
                            <X size={24} />
                            </button>
                        </div>
                        
                        <div className="p-4 md:p-6 flex-1 flex flex-col min-h-0">
                            {/* Controls */}
                            <div className="flex flex-col gap-4 mb-4 md:mb-6">
                            {/* Metric Toggles */}
                            <div className="flex flex-wrap gap-2">
                                <button
                                onClick={() => setGraphMetric('snow')}
                                className={`px-3 py-1.5 md:px-4 md:py-2 text-sm md:text-base rounded-lg font-medium transition-colors ${graphMetric === 'snow' ? 'bg-cyan-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                                >
                                Snowfall
                                </button>
                                <button
                                onClick={() => setGraphMetric('temp')}
                                className={`px-3 py-1.5 md:px-4 md:py-2 text-sm md:text-base rounded-lg font-medium transition-colors ${graphMetric === 'temp' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                                >
                                Max Temp
                                </button>
                                <button
                                onClick={() => setGraphMetric('daylight')}
                                className={`px-3 py-1.5 md:px-4 md:py-2 text-sm md:text-base rounded-lg font-medium transition-colors ${graphMetric === 'daylight' ? 'bg-yellow-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                                >
                                Daylight
                                </button>
                            </div>

                            {/* Year Toggles */}
                            <div className="flex flex-wrap gap-2 items-center">
                                <span className="text-sm font-medium text-gray-500 mr-2">Years:</span>
                                {graphYears.map((y, i) => {
                                const colors = ['#3b82f6', '#ef4444', '#22c55e', '#f97316', '#a855f7'];
                                const color = colors[i % colors.length];
                                return (
                                    <button
                                    key={y}
                                    onClick={() => setVisibleYears(prev => ({ ...prev, [y]: !prev[y] }))}
                                    className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium transition-colors border ${visibleYears[y] ? 'bg-white' : 'bg-gray-100 text-gray-400 border-gray-200'}`}
                                    style={{ borderColor: visibleYears[y] ? color : 'transparent' }}
                                    >
                                    <div 
                                        className="w-3 h-3 rounded-full" 
                                        style={{ backgroundColor: visibleYears[y] ? color : '#9ca3af' }}
                                    />
                                    {y}
                                    </button>
                                );
                                })}
                            </div>

                            {/* Month Toggles */}
                            <div className="flex flex-wrap gap-1 items-center">
                                <span className="text-sm font-medium text-gray-500 mr-2">Months:</span>
                                {MONTHS.map((m, i) => (
                                <button
                                    key={m}
                                    onClick={() => setVisibleMonths(prev => ({ ...prev, [i]: !prev[i] }))}
                                    className={`px-2 py-1 text-xs rounded border transition-colors ${visibleMonths[i] ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-gray-50 border-gray-200 text-gray-400'}`}
                                >
                                    {m.substring(0, 3)}
                                </button>
                                ))}
                                <button 
                                    onClick={() => setVisibleMonths(Object.fromEntries(Array.from({ length: 12 }, (_, i) => [i, true])))}
                                    className="ml-2 text-xs text-blue-600 hover:underline"
                                >
                                    All
                                </button>
                                <button 
                                    onClick={() => setVisibleMonths(Object.fromEntries(Array.from({ length: 12 }, (_, i) => [i, false])))}
                                    className="ml-2 text-xs text-blue-600 hover:underline"
                                >
                                    None
                                </button>
                            </div>
                            </div>

                            {loadingGraph ? (
                            <div className="flex-1 flex items-center justify-center">
                                <div className="animate-spin text-4xl">‚åõ</div>
                            </div>
                            ) : (
                            <div className="flex-1 min-h-0">
                                <ResponsiveContainer width="100%" height="100%">
                                <LineChart 
                                    data={graphData ? graphData[graphMetric].filter(d => visibleMonths[d.month]) : []} 
                                    margin={isMobile ? { top: 5, right: 5, left: 40, bottom: 60 } : { top: 5, right: 30, left: 20, bottom: 5 }}
                                    layout={isMobile ? "vertical" : "horizontal"}
                                >
                                    <CartesianGrid strokeDasharray="3 3" vertical={!isMobile} />
                                    {isMobile ? (
                                        <>
                                            <XAxis 
                                                type="number"
                                                unit={graphMetric === 'temp' ? '¬∞F' : graphMetric === 'daylight' ? 'h' : '"'} 
                                            />
                                            <YAxis 
                                                dataKey="label" 
                                                type="category"
                                                tick={{fontSize: 10}}
                                                width={35}
                                            />
                                        </>
                                    ) : (
                                        <>
                                            <XAxis 
                                                dataKey="label" 
                                                interval={30} 
                                                tick={{fontSize: 12}}
                                            />
                                            <YAxis 
                                                unit={graphMetric === 'temp' ? '¬∞F' : graphMetric === 'daylight' ? 'h' : '"'} 
                                                label={{ 
                                                    value: graphMetric === 'temp' ? 'Temperature (¬∞F)' : graphMetric === 'daylight' ? 'Hours' : 'Snowfall (inches)', 
                                                    angle: -90, 
                                                    position: 'insideLeft' 
                                                }} 
                                            />
                                        </>
                                    )}
                                    <Tooltip 
                                        contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}
                                    />
                                    <Legend />
                                    {graphYears.map((y, i) => {
                                        const colors = ['#3b82f6', '#ef4444', '#22c55e', '#f97316', '#a855f7'];
                                        return visibleYears[y] && (
                                            <Line 
                                                key={y}
                                                type="monotone" 
                                                dataKey={y} 
                                                stroke={colors[i % colors.length]} 
                                                dot={false}
                                                strokeWidth={2}
                                                connectNulls
                                                activeDot={{ r: 6 }}
                                            />
                                        );
                                    })}
                                </LineChart>
                                </ResponsiveContainer>
                            </div>
                            )}
                        </div>
                        </div>
                    </div>
                    )}

                    {/* Calendar and Details */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    {/* Calendar */}
                    <div className="lg:col-span-2 bg-white rounded-lg shadow-lg p-6">
                        <div className="mb-6">
                        <h2 className="text-2xl font-bold text-gray-800 mb-3">
                            {MONTHS[month]} {year}
                        </h2>
                        <p className="text-gray-600 mb-4">Click on a day to see details</p>
                        
                        {/* Data Visibility Toggles */}
                        <div className="flex flex-wrap gap-2 mb-4">
                            <button
                            onClick={() => setShowSnowfall(!showSnowfall)}
                            className={`px-3 py-1.5 rounded-lg font-medium text-sm transition-colors ${
                                showSnowfall ? 'bg-blue-100 text-blue-700 border border-blue-300' : 'bg-gray-100 text-gray-500 border border-gray-300'
                            }`}
                            >
                            ‚ùÑ Snowfall {showSnowfall ? '‚úì' : ''}
                            </button>
                            <button
                            onClick={() => setShowPrecipitation(!showPrecipitation)}
                            className={`px-3 py-1.5 rounded-lg font-medium text-sm transition-colors ${
                                showPrecipitation ? 'bg-blue-100 text-blue-700 border border-blue-300' : 'bg-gray-100 text-gray-500 border border-gray-300'
                            }`}
                            >
                            üíß Precipitation {showPrecipitation ? '‚úì' : ''}
                            </button>
                        </div>
                        </div>

                        {loading && <p className="text-gray-600">Loading weather data...</p>}
                        {error && <p className="text-red-600">Error: {error}</p>}

                        {!loading && !error && (
                        <div className="grid grid-cols-7 gap-1 md:gap-2">
                            {DAYS_OF_WEEK.map((day) => (
                            <div key={day} className="text-center font-semibold text-gray-600 text-xs md:text-sm mb-1 md:mb-2">
                                {day}
                            </div>
                            ))}
                            {renderCalendarDays()}
                        </div>
                        )}
                    </div>

                    {/* Details Panel */}
                    <div className="bg-white rounded-lg shadow-lg p-6">
                        <h3 className="text-xl font-bold text-gray-800 mb-4">
                        {DAYS_OF_WEEK[selectedDate.getDay()]}, {MONTHS[selectedDate.getMonth()]} {selectedDate.getDate()}
                        </h3>

                        {loading ? (
                        <p className="text-gray-600">Loading...</p>
                        ) : selectedData ? (
                        <div className="space-y-4">
                            <div className="flex items-center gap-2 p-3 bg-blue-50 rounded">
                            <Thermometer className="text-red-500" />
                            <div>
                                <p className="text-xs text-gray-600">Temperature</p>
                                <p className="font-bold text-lg">{selectedData.tempMax}¬∞F / {selectedData.tempMin}¬∞F</p>
                            </div>
                            </div>

                            <div className="flex items-center gap-2 p-3 bg-blue-50 rounded">
                            <Droplets className="text-blue-500" />
                            <div>
                                <p className="text-xs text-gray-600">Precipitation</p>
                                <p className="font-bold text-lg">{selectedData.precipitation}"</p>
                            </div>
                            </div>

                            <div className="flex items-center gap-2 p-3 bg-blue-50 rounded">
                            <Snowflake className="text-blue-300" />
                            <div>
                                <p className="text-xs text-gray-600">Snowfall</p>
                                <p className="font-bold text-lg">{selectedData.snowfall}"</p>
                            </div>
                            </div>

                            <div className="flex items-center gap-2 p-3 bg-blue-50 rounded">
                            <Wind className="text-gray-500" />
                            <div>
                                <p className="text-xs text-gray-600">Wind Speed</p>
                                <p className="font-bold text-lg">{selectedData.windSpeed} mph</p>
                            </div>
                            </div>

                            <div className="flex items-center gap-2 p-3 bg-orange-50 rounded">
                            <Sunrise className="text-orange-500" />
                            <div>
                                <p className="text-xs text-gray-600">Sunrise</p>
                                <p className="font-bold text-lg">{formatTime(selectedData.sunrise)}</p>
                            </div>
                            </div>

                            <div className="flex items-center gap-2 p-3 bg-orange-50 rounded">
                            <Sunset className="text-orange-600" />
                            <div>
                                <p className="text-xs text-gray-600">Sunset</p>
                                <p className="font-bold text-lg">{formatTime(selectedData.sunset)}</p>
                            </div>
                            </div>

                            <div className="flex items-center gap-2 p-3 bg-yellow-50 rounded">
                            <Clock className="text-yellow-600" />
                            <div>
                                <p className="text-xs text-gray-600">Daylight</p>
                                <p className="font-bold text-lg">{formatDuration(selectedData.daylightDuration)}</p>
                            </div>
                            </div>
                        </div>
                        ) : (
                        <p className="text-gray-600">No data available for this date</p>
                        )}

                        {/* Historical Comparison Section */}
                        <div className="mt-8 pt-6 border-t border-gray-200">
                        <div className="flex items-center justify-between mb-4">
                            <h4 className="font-bold text-gray-800 flex items-center gap-2">
                            <History size={18} />
                            Historical Context
                            </h4>
                            <button
                            onClick={fetchHistoricalComparison}
                            disabled={loadingHistory}
                            className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200"
                            >
                            {loadingHistory ? 'Loading...' : 'Analyze History'}
                            </button>
                        </div>

                        {historicalAverages && (
                            <div className="space-y-3">
                            {[1, 3, 10].map((yearsAgo) => {
                                const data = historicalAverages[yearsAgo];
                                if (!data) return null;
                                return (
                                <div key={yearsAgo} className="text-sm bg-gray-50 p-2 rounded">
                                    <div className="flex justify-between font-medium text-gray-700 mb-1">
                                    <span>{data.year} ({yearsAgo}y ago)</span>
                                    <span>{data.tempMax}¬∞ / {data.tempMin}¬∞</span>
                                    </div>
                                    <div className="flex gap-3 text-xs text-gray-500">
                                    {data.precip > 0 && <span>üíß {data.precip}"</span>}
                                    {data.snow > 0 && <span>‚ùÑ {data.snow}"</span>}
                                    {data.precip === 0 && data.snow === 0 && <span>No precip</span>}
                                    </div>
                                </div>
                                );
                            })}
                            </div>
                        )}
                        {!historicalAverages && !loadingHistory && (
                            <p className="text-xs text-gray-500 italic">
                            Click "Analyze History" to compare this date with previous years (1y, 3y, 10y ago).
                            </p>
                        )}
                        </div>
                    </div>
                    </div>
                </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
