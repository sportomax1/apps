<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Forecast - v2</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
        .modal { z-index: 50; }
        .modal-content { z-index: 51; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // ----- WEATHER APP -----
        const DAYS_OF_WEEK = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        
        const currentYear = new Date().getFullYear();
        const YEARS = Array.from({ length: currentYear - 1990 + 2 }, (_, i) => currentYear + 1 - i);

        const DEFAULT_LOCATIONS = [
            { name: 'Parker, CO', lat: 39.5186, lon: -104.7614 },
            { name: 'Uehling, NE', lat: 41.7336, lon: -96.5028 },
            { name: 'San Diego, CA', lat: 32.7157, lon: -117.1611 },
            { name: 'Chicago, IL', lat: 41.8781, lon: -87.6298 },
            { name: 'Rochester, NY', lat: 43.1566, lon: -77.6088 },
            { name: 'Clayton, NY', lat: 44.2395, lon: -76.0858 },
        ];

        // State management
        let appState = {
            currentDate: new Date(),
            selectedDate: new Date(),
            locations: DEFAULT_LOCATIONS,
            location: DEFAULT_LOCATIONS[0],
            weatherData: {},
            loading: false,
            error: null,
            searchQuery: '',
            isSearching: false,
            showThisDate: false,
            thisDateData: null,
            loadingThisDate: false,
            showHistoryGrid: false,
            gridData: null,
            loadingGrid: false,
            gridMetric: 'temp',
            showGraph: false,
            graphData: null,
            loadingGraph: false,
            graphYears: [],
            visibleYears: {},
            graphMetric: 'snow',
            visibleMonths: Object.fromEntries(Array.from({ length: 12 }, (_, i) => [i, true])),
            showSnowfall: true,
            showPrecipitation: true,
            isMobile: window.innerWidth < 768,
            chartInstance: null
        };

        function setState(updates) {
            appState = { ...appState, ...updates };
            render();
        }

        function formatDateAPI(date) {
            return date.toISOString().split('T')[0];
        }

        function formatTime(isoString) {
            if (!isoString || !isoString.includes('T')) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        }

        function formatDuration(seconds) {
            if (typeof seconds !== 'number' || seconds < 0) return 'N/A';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }

        // Handle month/year changes
        function handleMonthChange(increment) {
            const newDate = new Date(appState.currentDate);
            newDate.setMonth(newDate.getMonth() + increment);
            setState({ currentDate: newDate });
            fetchWeatherData();
        }

        function handleYearChange(increment) {
            const newDate = new Date(appState.currentDate);
            newDate.setFullYear(newDate.getFullYear() + increment);
            setState({ currentDate: newDate });
            fetchWeatherData();
        }

        function handleJumpToToday() {
            const today = new Date();
            setState({ currentDate: today, selectedDate: today });
            fetchWeatherData();
        }

        function handleCurrentLocation() {
            if (navigator.geolocation) {
                setState({ loading: true });
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const newLoc = {
                            name: 'My Location',
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        const newLocations = [...appState.locations, newLoc];
                        setState({ locations: newLocations, location: newLoc, loading: false });
                        fetchWeatherData();
                    },
                    () => {
                        setState({ error: 'Location access denied', loading: false });
                    }
                );
            } else {
                setState({ error: 'Geolocation not supported' });
            }
        }

        function handleSearchLocation(e) {
            e.preventDefault();
            if (!appState.searchQuery.trim()) return;

            setState({ isSearching: true });
            fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(appState.searchQuery)}&count=1&language=en&format=json`)
                .then(res => res.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        const result = data.results[0];
                        const newLoc = {
                            name: `${result.name}, ${result.admin1 || result.country_code}`,
                            lat: result.latitude,
                            lon: result.longitude
                        };
                        const newLocations = [...appState.locations, newLoc];
                        setState({ locations: newLocations, location: newLoc, searchQuery: '', isSearching: false });
                        fetchWeatherData();
                    } else {
                        setState({ error: 'Location not found', isSearching: false });
                    }
                })
                .catch(err => {
                    setState({ error: 'Search failed', isSearching: false });
                });
        }

        function fetchWeatherData() {
            setState({ loading: true, error: null });
            
            const year = appState.currentDate.getFullYear();
            const month = appState.currentDate.getMonth();
            const startDate = formatDateAPI(new Date(year, month, 1));
            const endDate = formatDateAPI(new Date(year, month + 1, 0));
            
            const tenDaysAgo = new Date();
            tenDaysAgo.setDate(tenDaysAgo.getDate() - 10);
            const isHistorical = new Date(year, month, 28) < tenDaysAgo;
            
            const params = `&daily=precipitation_sum,snowfall_sum,temperature_2m_max,temperature_2m_min,wind_speed_10m_max,sunrise,sunset,daylight_duration&temperature_unit=fahrenheit&precipitation_unit=inch&wind_speed_unit=mph&timezone=auto`;
            
            let url = '';
            if (isHistorical) {
                url = `https://archive-api.open-meteo.com/v1/archive?latitude=${appState.location.lat}&longitude=${appState.location.lon}&start_date=${startDate}&end_date=${endDate}${params}`;
            } else {
                const maxForecastDate = new Date();
                maxForecastDate.setDate(maxForecastDate.getDate() + 14);
                const clampedEnd = new Date(endDate) > maxForecastDate ? formatDateAPI(maxForecastDate) : endDate;
                url = `https://api.open-meteo.com/v1/forecast?latitude=${appState.location.lat}&longitude=${appState.location.lon}&start_date=${startDate}&end_date=${clampedEnd}${params}`;
            }

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    const processed = {};
                    if (data.daily && data.daily.time) {
                        data.daily.time.forEach((time, index) => {
                            processed[time] = {
                                precipitation: data.daily.precipitation_sum[index],
                                snowfall: data.daily.snowfall_sum[index],
                                tempMax: data.daily.temperature_2m_max[index],
                                tempMin: data.daily.temperature_2m_min[index],
                                windSpeed: data.daily.wind_speed_10m_max[index],
                                sunrise: data.daily.sunrise[index],
                                sunset: data.daily.sunset[index],
                                daylightDuration: data.daily.daylight_duration[index],
                            };
                        });
                    }
                    setState({ weatherData: processed, loading: false });
                })
                .catch(err => {
                    setState({ error: err.message || 'Failed to fetch data', loading: false, weatherData: {} });
                });
        }

        function fetchThisDateHistory() {
            setState({ loadingThisDate: true, thisDateData: null });
            
            const month = appState.selectedDate.getMonth() + 1;
            const day = appState.selectedDate.getDate();
            const currentYear = new Date().getFullYear();
            
            const yearsToFetch = Array.from({ length: 20 }, (_, i) => currentYear - i);
            const historyData = {};
            let completed = 0;

            yearsToFetch.forEach((targetYear) => {
                const dateStr = `${targetYear}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                
                const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${appState.location.lat}&longitude=${appState.location.lon}&start_date=${dateStr}&end_date=${dateStr}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,snowfall_sum,sunrise,sunset,daylight_duration&temperature_unit=fahrenheit&precipitation_unit=inch&timezone=auto`;
                console.log('fetchThisDateHistory: fetching', dateStr, url);
                
                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        console.log('fetchThisDateHistory: response for', targetYear, data && data.daily && data.daily.time ? data.daily.time[0] : 'no-data');
                        if (data.daily && data.daily.time && data.daily.time.length > 0) {
                            historyData[targetYear] = {
                                tempMax: data.daily.temperature_2m_max[0],
                                tempMin: data.daily.temperature_2m_min[0],
                                precip: data.daily.precipitation_sum[0] || 0,
                                snow: data.daily.snowfall_sum[0] || 0,
                                sunrise: data.daily.sunrise[0],
                                sunset: data.daily.sunset[0],
                                daylight: data.daily.daylight_duration[0]
                            };
                        } else {
                            console.warn('fetchThisDateHistory: no daily data for', targetYear, dateStr);
                        }
                        completed++;
                        if (completed === yearsToFetch.length) {
                            const sortedData = yearsToFetch.filter(y => historyData[y]).map(y => ({ year: y, ...historyData[y] }));
                            console.log('fetchThisDateHistory: completed, entries=', sortedData.length);
                            setState({ thisDateData: sortedData, loadingThisDate: false });
                        }
                    })
                    .catch(err => {
                        console.error('fetchThisDateHistory: fetch error for', targetYear, err);
                        completed++;
                        if (completed === yearsToFetch.length) {
                            const sortedData = yearsToFetch.filter(y => historyData[y]).map(y => ({ year: y, ...historyData[y] }));
                            setState({ thisDateData: sortedData, loadingThisDate: false });
                        }
                    });
            });
        }

        // Debug-friendly click handler for This Date button
        function handleThisDateClick() {
            console.log('handleThisDateClick: clicked - selectedDate=', appState.selectedDate, 'location=', appState.location);
            try {
                setState({ showThisDate: true });
                fetchThisDateHistory();
            } catch (err) {
                console.error('handleThisDateClick: error', err);
            }
        }

        // global error hook
        window.addEventListener('error', function (event) {
            console.error('Window error:', event.message, 'at', event.filename + ':' + event.lineno + ':' + event.colno, event.error);
        });

        // expose some debug helpers
        window.__appState = function () { return appState; };

        function fetchGridHistory() {
            if (appState.gridData) return;
            
            setState({ loadingGrid: true });
            const currentYear = new Date().getFullYear();
            const years = [currentYear, currentYear - 1, currentYear - 2, currentYear - 3];
            const startDate = `${years[years.length - 1]}-01-01`;
            
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 5);
            const endDate = formatDateAPI(yesterday);
            
            const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${appState.location.lat}&longitude=${appState.location.lon}&start_date=${startDate}&end_date=${endDate}&daily=temperature_2m_mean,precipitation_sum,snowfall_sum&temperature_unit=fahrenheit&precipitation_unit=inch&timezone=auto`;
            
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (!data.daily) throw new Error('No data');

                    const processed = {};
                    data.daily.time.forEach((dateStr, i) => {
                        const date = new Date(dateStr);
                        const m = date.getMonth();
                        const y = date.getFullYear();
                        
                        if (!processed[m]) processed[m] = {};
                        if (!processed[m][y]) processed[m][y] = { tempSum: 0, precip: 0, snow: 0, count: 0 };
                        
                        const d = processed[m][y];
                        if (data.daily.temperature_2m_mean[i] !== null) {
                            d.tempSum += data.daily.temperature_2m_mean[i];
                            d.count++;
                        }
                        d.precip += data.daily.precipitation_sum[i] || 0;
                        d.snow += data.daily.snowfall_sum[i] || 0;
                    });

                    setState({ gridData: processed, loadingGrid: false });
                })
                .catch(err => {
                    console.error('Grid fetch failed', err);
                    setState({ loadingGrid: false });
                });
        }

        function fetchGraphData() {
            if (appState.graphData) return;
            
            setState({ loadingGraph: true });
            const currentYear = new Date().getFullYear();
            const years = [currentYear, currentYear - 1, currentYear - 2, currentYear - 3, currentYear - 4];
            
            const initialVisible = {};
            years.forEach(y => initialVisible[y] = true);

            const startDate = `${years[years.length - 1]}-01-01`;
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 5);
            const endDate = formatDateAPI(yesterday);
            
            const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${appState.location.lat}&longitude=${appState.location.lon}&start_date=${startDate}&end_date=${endDate}&daily=snowfall_sum,temperature_2m_max,daylight_duration&temperature_unit=fahrenheit&precipitation_unit=inch&timezone=auto`;
            
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (!data.daily) throw new Error('No data');

                    const createBaseArray = () => {
                        const arr = [];
                        const tempDate = new Date(2020, 0, 1); 
                        for (let i = 0; i < 366; i++) {
                            const m = tempDate.getMonth();
                            const d = tempDate.getDate();
                            const label = `${MONTHS[m].substring(0, 3)} ${d}`;
                            
                            const dayObj = { label, month: m, day: d };
                            years.forEach(y => dayObj[y] = null);
                            arr.push(dayObj);
                            tempDate.setDate(tempDate.getDate() + 1);
                        }
                        return arr;
                    };

                    const snowData = createBaseArray();
                    const tempData = createBaseArray();
                    const daylightData = createBaseArray();

                    data.daily.time.forEach((dateStr, i) => {
                        const [yStr, mStr, dStr] = dateStr.split('-');
                        const y = parseInt(yStr);
                        const m = parseInt(mStr) - 1;
                        const d = parseInt(dStr);
                        
                        if (!years.includes(y)) return;

                        const dayIndex = snowData.findIndex(item => item.month === m && item.day === d);
                        if (dayIndex !== -1) {
                            snowData[dayIndex][y] = data.daily.snowfall_sum[i];
                            tempData[dayIndex][y] = data.daily.temperature_2m_max[i];
                            daylightData[dayIndex][y] = data.daily.daylight_duration[i] ? (data.daily.daylight_duration[i] / 3600) : null;
                        }
                    });

                    setState({ 
                        graphData: { snow: snowData, temp: tempData, daylight: daylightData },
                        graphYears: years,
                        visibleYears: initialVisible,
                        loadingGraph: false 
                    });
                })
                .catch(err => {
                    console.error('Graph fetch failed', err);
                    setState({ loadingGraph: false });
                });
        }

        // Render calendar days
        function renderCalendarDays() {
            const year = appState.currentDate.getFullYear();
            const month = appState.currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayOfMonth = new Date(year, month, 1).getDay();

            let html = '';
            
            for (let i = 0; i < firstDayOfMonth; i++) {
                html += '<div class="aspect-square"></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = formatDateAPI(date);
                const isSelected = dateStr === formatDateAPI(appState.selectedDate);
                const data = appState.weatherData[dateStr];

                html += `
                    <button
                    onclick="setState({ selectedDate: new Date('${dateStr}') })"
                    class="aspect-square rounded-lg p-1 md:p-2 text-xs md:text-sm font-medium transition-colors flex flex-col items-center justify-start
                        ${isSelected ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'}
                        ${data && (data.precipitation > 0 || data.snowfall > 0) ? 'ring-1 md:ring-2 ring-blue-400' : ''}
                    "
                    >
                    <div>${day}</div>
                    ${data ? `
                        <div class="text-[10px] md:text-xs mt-0.5 md:mt-1 leading-tight">
                        ${appState.showSnowfall && data.snowfall > 0 ? `<div class="text-blue-600 font-bold">‚ùÑ ${data.snowfall.toFixed(1)}"</div>` : ''}
                        ${appState.showPrecipitation && data.precipitation > 0 && data.snowfall === 0 ? `<div class="text-blue-500 font-bold">üíß ${data.precipitation.toFixed(2)}"</div>` : ''}
                        </div>
                    ` : ''}
                    </button>
                `;
            }

            return html;
        }

        // Main render function
        function render() {
            const year = appState.currentDate.getFullYear();
            const month = appState.currentDate.getMonth();
            const selectedDateStr = formatDateAPI(appState.selectedDate);
            const selectedData = appState.weatherData[selectedDateStr];

            const html = `
                <div class="min-h-screen bg-gradient-to-br from-blue-400 to-blue-600 p-4 md:p-8">
                <div class="max-w-6xl mx-auto">
                    <!-- Header -->
                    <div class="mb-6 md:mb-8">
                    <h1 class="text-2xl md:text-4xl font-bold text-white mb-2">Weather Forecast</h1>
                    <p class="text-blue-100 text-sm md:text-base">Historical and predicted weather data</p>
                    </div>

                    <!-- Controls -->
                    <div class="bg-white rounded-lg shadow-lg p-4 md:p-6 mb-6 md:mb-8">
                    <div class="flex flex-col md:grid md:grid-cols-2 gap-6">
                        <!-- Location Selector & Search -->
                        <div class="space-y-4">
                        <div class="flex gap-2">
                            <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                            <select
                                onchange="setState({ location: appState.locations[this.value] }); fetchWeatherData();"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            >
                                ${appState.locations.map((loc, i) => `<option value="${i}" ${appState.location === loc ? 'selected' : ''}>${loc.name}</option>`).join('')}
                            </select>
                            </div>
                            <div class="flex items-end">
                            <button
                                onclick="handleCurrentLocation()"
                                class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors"
                                title="Use Current Location"
                            >
                            üìç
                            </button>
                            </div>
                        </div>

                        <form onsubmit="handleSearchLocation(event)" class="flex gap-2">
                            <input
                            type="text"
                            id="searchInput"
                            value="${appState.searchQuery}"
                            onchange="setState({ searchQuery: this.value })"
                            placeholder="Search city..."
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                            <button
                            type="submit"
                            ${appState.isSearching ? 'disabled' : ''}
                            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50"
                            >
                            ${appState.isSearching ? '‚åõ' : 'üîç'}
                            </button>
                        </form>
                        </div>

                        <!-- Month/Year Selector & Tools -->
                        <div class="space-y-4">
                        <!-- Month Navigation -->
                        <div class="flex gap-2 items-end">
                            <button 
                            onclick="handleMonthChange(-1)"
                            class="p-2 hover:bg-gray-100 rounded-lg transition-colors flex-shrink-0"
                            title="Previous Month"
                            >
                            ‚óÄ
                            </button>
                            
                            <div class="flex-1">
                                <label class="block text-xs md:text-sm font-medium text-gray-700 mb-1 md:mb-2">Month</label>
                                <select
                                onchange="setState({ currentDate: new Date(${year}, this.value, 1) }); fetchWeatherData();"
                                class="w-full px-2 md:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                                >
                                ${MONTHS.map((m, i) => `<option value="${i}" ${i === month ? 'selected' : ''}>${m}</option>`).join('')}
                                </select>
                            </div>

                            <button 
                            onclick="handleMonthChange(1)"
                            class="p-2 hover:bg-gray-100 rounded-lg transition-colors flex-shrink-0"
                            title="Next Month"
                            >
                            ‚ñ∂
                            </button>
                        </div>

                        <!-- Year Navigation -->
                        <div class="flex gap-2 items-end">
                            <button 
                            onclick="handleYearChange(-1)"
                            class="p-2 hover:bg-gray-100 rounded-lg transition-colors flex-shrink-0"
                            title="Previous Year"
                            >
                            ‚óÄ
                            </button>
                            
                            <div class="flex-1">
                                <label class="block text-xs md:text-sm font-medium text-gray-700 mb-1 md:mb-2">Year</label>
                                <select
                                onchange="setState({ currentDate: new Date(this.value, ${month}, 1) }); fetchWeatherData();"
                                class="w-full px-2 md:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                                >
                                ${YEARS.map(y => `<option value="${y}" ${y === year ? 'selected' : ''}>${y}</option>`).join('')}
                                </select>
                            </div>

                            <button 
                            onclick="handleYearChange(1)"
                            class="p-2 hover:bg-gray-100 rounded-lg transition-colors flex-shrink-0"
                            title="Next Year"
                            >
                            ‚ñ∂
                            </button>
                        </div>
                        
                        <div class="flex flex-row justify-end gap-1 md:gap-2 flex-wrap">
                            <button
                            onclick="setState({ showGraph: true }); fetchGraphData();"
                            class="flex items-center justify-center gap-1 px-2 md:px-4 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition-colors text-xs md:text-base whitespace-nowrap"
                            >
                            üìà Graph View
                            </button>
                            <button
                            onclick="setState({ showHistoryGrid: true }); fetchGridHistory();"
                            class="flex items-center justify-center gap-1 px-2 md:px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors text-xs md:text-base whitespace-nowrap"
                            >
                            üìä History Grid
                            </button>
                            <button
                            onclick="handleThisDateClick()"
                            class="flex items-center justify-center gap-1 px-2 md:px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors text-xs md:text-base whitespace-nowrap"
                            >
                            üìÖ This Date
                            </button>
                            <button
                            onclick="handleJumpToToday()"
                            class="flex items-center justify-center gap-1 px-2 md:px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-xs md:text-base whitespace-nowrap"
                            >
                            üîÑ Jump
                            </button>
                        </div>
                        </div>
                    </div>
                    </div>

                    <!-- Calendar and Details -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Calendar -->
                    <div class="lg:col-span-2 bg-white rounded-lg shadow-lg p-6">
                        <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-3">
                            ${MONTHS[month]} ${year}
                        </h2>
                        <p class="text-gray-600 mb-4">Click on a day to see details</p>
                        
                        <!-- Data Visibility Toggles -->
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button
                            onclick="setState({ showSnowfall: !appState.showSnowfall })"
                            class="px-3 py-1.5 rounded-lg font-medium text-sm transition-colors ${
                                appState.showSnowfall ? 'bg-blue-100 text-blue-700 border border-blue-300' : 'bg-gray-100 text-gray-500 border border-gray-300'
                            }"
                            >
                            ‚ùÑ Snowfall ${appState.showSnowfall ? '‚úì' : ''}
                            </button>
                            <button
                            onclick="setState({ showPrecipitation: !appState.showPrecipitation })"
                            class="px-3 py-1.5 rounded-lg font-medium text-sm transition-colors ${
                                appState.showPrecipitation ? 'bg-blue-100 text-blue-700 border border-blue-300' : 'bg-gray-100 text-gray-500 border border-gray-300'
                            }"
                            >
                            üíß Precipitation ${appState.showPrecipitation ? '‚úì' : ''}
                            </button>
                        </div>
                        </div>

                        ${appState.loading ? '<p class="text-gray-600">Loading weather data...</p>' : ''}
                        ${appState.error ? `<p class="text-red-600">Error: ${appState.error}</p>` : ''}

                        ${!appState.loading && !appState.error ? `
                        <div class="grid grid-cols-7 gap-1 md:gap-2">
                            ${DAYS_OF_WEEK.map(day => `<div class="text-center font-semibold text-gray-600 text-xs md:text-sm mb-1 md:mb-2">${day}</div>`).join('')}
                            ${renderCalendarDays()}
                        </div>
                        ` : ''}
                    </div>

                    <!-- Details Panel -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                        ${DAYS_OF_WEEK[appState.selectedDate.getDay()]}, ${MONTHS[appState.selectedDate.getMonth()]} ${appState.selectedDate.getDate()}
                        </h3>

                        ${appState.loading ? '<p class="text-gray-600">Loading...</p>' : selectedData ? `
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 p-3 bg-blue-50 rounded">
                            <span class="text-2xl">üå°Ô∏è</span>
                            <div>
                                <p class="text-xs text-gray-600">Temperature</p>
                                <p class="font-bold text-lg">${selectedData.tempMax.toFixed(0)}¬∞F / ${selectedData.tempMin.toFixed(0)}¬∞F</p>
                            </div>
                            </div>

                            <div class="flex items-center gap-2 p-3 bg-blue-50 rounded">
                            <span class="text-2xl">üíß</span>
                            <div>
                                <p class="text-xs text-gray-600">Precipitation</p>
                                <p class="font-bold text-lg">${selectedData.precipitation.toFixed(2)}"</p>
                            </div>
                            </div>

                            <div class="flex items-center gap-2 p-3 bg-blue-50 rounded">
                            <span class="text-2xl">‚ùÑÔ∏è</span>
                            <div>
                                <p class="text-xs text-gray-600">Snowfall</p>
                                <p class="font-bold text-lg">${selectedData.snowfall.toFixed(1)}"</p>
                            </div>
                            </div>

                            <div class="flex items-center gap-2 p-3 bg-blue-50 rounded">
                            <span class="text-2xl">üí®</span>
                            <div>
                                <p class="text-xs text-gray-600">Wind Speed</p>
                                <p class="font-bold text-lg">${selectedData.windSpeed.toFixed(1)} mph</p>
                            </div>
                            </div>

                            <div class="flex items-center gap-2 p-3 bg-orange-50 rounded">
                            <span class="text-2xl">üåÖ</span>
                            <div>
                                <p class="text-xs text-gray-600">Sunrise</p>
                                <p class="font-bold text-lg">${formatTime(selectedData.sunrise)}</p>
                            </div>
                            </div>

                            <div class="flex items-center gap-2 p-3 bg-orange-50 rounded">
                            <span class="text-2xl">üåá</span>
                            <div>
                                <p class="text-xs text-gray-600">Sunset</p>
                                <p class="font-bold text-lg">${formatTime(selectedData.sunset)}</p>
                            </div>
                            </div>

                            <div class="flex items-center gap-2 p-3 bg-yellow-50 rounded">
                            <span class="text-2xl">‚è∞</span>
                            <div>
                                <p class="text-xs text-gray-600">Daylight</p>
                                <p class="font-bold text-lg">${formatDuration(selectedData.daylightDuration)}</p>
                            </div>
                            </div>
                        </div>
                        ` : '<p class="text-gray-600">No data available for this date</p>'}
                    </div>
                    </div>
                </div>
                </div>

                ${appState.showHistoryGrid ? `
                <div class="fixed inset-0 bg-black/50 flex items-center justify-center modal p-4">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col modal-content m-4">
                    <div class="p-4 md:p-6 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                        <div>
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800">Historical Analysis</h2>
                        <p class="text-gray-600 text-xs md:text-sm">${appState.location.name}</p>
                        </div>
                        <button 
                        onclick="setState({ showHistoryGrid: false })"
                        class="p-2 hover:bg-gray-200 rounded-full transition-colors"
                        >
                        ‚úï
                        </button>
                    </div>
                    
                    <div class="p-4 md:p-6 overflow-auto flex-1">
                        <div class="flex flex-wrap gap-2 md:gap-4 mb-4 md:mb-6">
                        <button
                            onclick="setState({ gridMetric: 'temp' })"
                            class="px-3 py-1.5 md:px-4 md:py-2 text-sm md:text-base rounded-lg font-medium transition-colors ${appState.gridMetric === 'temp' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"
                        >
                            Avg Temperature
                        </button>
                        <button
                            onclick="setState({ gridMetric: 'precip' })"
                            class="px-3 py-1.5 md:px-4 md:py-2 text-sm md:text-base rounded-lg font-medium transition-colors ${appState.gridMetric === 'precip' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"
                        >
                            Total Precipitation
                        </button>
                        <button
                            onclick="setState({ gridMetric: 'snow' })"
                            class="px-3 py-1.5 md:px-4 md:py-2 text-sm md:text-base rounded-lg font-medium transition-colors ${appState.gridMetric === 'snow' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"
                        >
                            Total Snowfall
                        </button>
                        </div>

                        ${appState.loadingGrid ? '<div class="flex justify-center py-12"><div class="animate-spin text-4xl">‚åõ</div></div>' : appState.gridData ? `
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                <th class="px-6 py-3">Month</th>
                                <th class="px-6 py-3">This Year (${new Date().getFullYear()})</th>
                                <th class="px-6 py-3">Last Year (${new Date().getFullYear() - 1})</th>
                                <th class="px-6 py-3">2 Years Ago (${new Date().getFullYear() - 2})</th>
                                <th class="px-6 py-3">3 Years Ago (${new Date().getFullYear() - 3})</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${MONTHS.map((monthName, mIndex) => {
                                    const currentYear = new Date().getFullYear();
                                    return `
                                    <tr class="bg-white border-b hover:bg-gray-50">
                                    <td class="px-6 py-4 font-medium text-gray-900">${monthName}</td>
                                    ${[0, 1, 2, 3].map(offset => {
                                        const y = currentYear - offset;
                                        const d = appState.gridData[mIndex]?.[y];
                                        let val = '-';
                                        if (d) {
                                            if (appState.gridMetric === 'temp') val = d.count ? (d.tempSum / d.count).toFixed(1) + '¬∞F' : '-';
                                            else if (appState.gridMetric === 'precip') val = d.precip.toFixed(2) + '"';
                                            else if (appState.gridMetric === 'snow') val = d.snow.toFixed(1) + '"';
                                        }
                                        return `<td class="px-6 py-4">${val}</td>`;
                                    }).join('')}
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                            </table>
                        </div>
                        ` : '<p class="text-center text-gray-500">No data available</p>'}
                    </div>
                    </div>
                </div>
                ` : ''}

                ${appState.showGraph ? `
                <div class="fixed inset-0 bg-black/50 flex items-center justify-center modal p-4">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col modal-content m-4">
                    <div class="p-4 md:p-6 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                        <div>
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800">Historical Trends</h2>
                        <p class="text-gray-600 text-xs md:text-sm">${appState.location.name} - Multi-Year Comparison</p>
                        </div>
                        <button 
                        onclick="setState({ showGraph: false })"
                        class="p-2 hover:bg-gray-200 rounded-full transition-colors"
                        >
                        ‚úï
                        </button>
                    </div>
                    
                    <div class="p-4 md:p-6 flex-1 flex flex-col min-h-0">
                        <div class="flex flex-col gap-4 mb-4 md:mb-6">
                        <div class="flex flex-wrap gap-2">
                            <button
                            onclick="setState({ graphMetric: 'snow' })"
                            class="px-3 py-1.5 md:px-4 md:py-2 text-sm md:text-base rounded-lg font-medium transition-colors ${appState.graphMetric === 'snow' ? 'bg-cyan-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"
                            >
                            Snowfall
                            </button>
                            <button
                            onclick="setState({ graphMetric: 'temp' })"
                            class="px-3 py-1.5 md:px-4 md:py-2 text-sm md:text-base rounded-lg font-medium transition-colors ${appState.graphMetric === 'temp' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"
                            >
                            Max Temp
                            </button>
                            <button
                            onclick="setState({ graphMetric: 'daylight' })"
                            class="px-3 py-1.5 md:px-4 md:py-2 text-sm md:text-base rounded-lg font-medium transition-colors ${appState.graphMetric === 'daylight' ? 'bg-yellow-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"
                            >
                            Daylight
                            </button>
                        </div>

                        <div class="flex flex-wrap gap-2 items-center">
                            <span class="text-sm font-medium text-gray-500 mr-2">Years:</span>
                            ${appState.graphYears.map((y, i) => {
                                const colors = ['#3b82f6', '#ef4444', '#22c55e', '#f97316', '#a855f7'];
                                const color = colors[i % colors.length];
                                return `
                                <button
                                onclick="setState({ visibleYears: { ...appState.visibleYears, ${y}: !appState.visibleYears[${y}] } }); renderChart();"
                                class="flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium transition-colors border ${appState.visibleYears[y] ? 'bg-white' : 'bg-gray-100 text-gray-400 border-gray-200'}"
                                style="border-color: ${appState.visibleYears[y] ? color : 'transparent'}"
                                >
                                <div class="w-3 h-3 rounded-full" style="background-color: ${appState.visibleYears[y] ? color : '#9ca3af'}"></div>
                                ${y}
                                </button>
                                `;
                            }).join('')}
                        </div>
                        </div>

                        <div id="chartContainer" class="flex-1 min-h-0">
                            <canvas id="myChart"></canvas>
                        </div>
                    </div>
                    </div>
                </div>
                ` : ''}

                ${appState.showThisDate ? `
                <div class="fixed inset-0 bg-black/50 flex items-center justify-center modal p-4">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col modal-content m-4">
                    <div class="p-4 md:p-6 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                        <div>
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800">This Date - Last 20 Years</h2>
                        <p class="text-gray-600 text-xs md:text-sm">${MONTHS[appState.selectedDate.getMonth()]} ${appState.selectedDate.getDate()} at ${appState.location.name}</p>
                        </div>
                        <button 
                        onclick="setState({ showThisDate: false })"
                        class="p-2 hover:bg-gray-200 rounded-full transition-colors"
                        >
                        ‚úï
                        </button>
                    </div>
                    
                    <div class="p-4 md:p-6 flex-1 overflow-auto">
                        ${appState.loadingThisDate ? '<div class="flex justify-center py-12"><div class="animate-spin text-4xl">‚åõ</div></div>' : appState.thisDateData && appState.thisDateData.length > 0 ? `
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left border-collapse">
                            <thead class="sticky top-0 text-xs text-gray-700 uppercase bg-gray-50 border-b border-gray-200">
                                <tr>
                                <th class="sticky left-0 bg-gray-50 px-3 md:px-6 py-3 font-semibold z-10 border-r border-gray-200">Year</th>
                                <th class="px-3 md:px-6 py-3 font-semibold whitespace-nowrap">Hi/Lo Temp</th>
                                <th class="px-3 md:px-6 py-3 font-semibold whitespace-nowrap">Precip + Snow</th>
                                <th class="px-3 md:px-6 py-3 font-semibold whitespace-nowrap">Sunrise</th>
                                <th class="px-3 md:px-6 py-3 font-semibold whitespace-nowrap">Sunset</th>
                                <th class="px-3 md:px-6 py-3 font-semibold whitespace-nowrap">Daylight</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${appState.thisDateData.map(d => `
                                <tr class="border-b border-gray-100 hover:bg-blue-50">
                                <td class="sticky left-0 bg-white hover:bg-blue-50 px-3 md:px-6 py-3 font-bold text-gray-900 border-r border-gray-200">${d.year}</td>
                                <td class="px-3 md:px-6 py-3 font-medium">${d.tempMax.toFixed(0)}¬∞ / ${d.tempMin.toFixed(0)}¬∞</td>
                                <td class="px-3 md:px-6 py-3">
                                    <div class="flex flex-col gap-1">
                                    ${d.precip > 0 ? `<div class="text-blue-600">üíß ${d.precip.toFixed(2)}"</div>` : ''}
                                    ${d.snow > 0 ? `<div class="text-blue-500">‚ùÑ ${d.snow.toFixed(1)}"</div>` : ''}
                                    ${d.precip === 0 && d.snow === 0 ? '<div class="text-gray-400 text-xs">‚Äî</div>' : ''}
                                    </div>
                                </td>
                                <td class="px-3 md:px-6 py-3">${formatTime(d.sunrise)}</td>
                                <td class="px-3 md:px-6 py-3">${formatTime(d.sunset)}</td>
                                <td class="px-3 md:px-6 py-3">${formatDuration(d.daylight)}</td>
                                </tr>
                                `).join('')}
                            </tbody>
                            </table>
                        </div>
                        ` : '<p class="text-center text-gray-500 py-8">No data available</p>'}
                    </div>
                    </div>
                </div>
                ` : ''}
            `;

            document.getElementById('root').innerHTML = html;

            if (appState.showGraph) {
                setTimeout(renderChart, 100);
            }
        }

        function renderChart() {
            if (!appState.graphData) return;

            const ctx = document.getElementById('myChart');
            if (!ctx) return;

            if (appState.chartInstance) {
                appState.chartInstance.destroy();
            }

            const data = appState.graphData[appState.graphMetric]
                .filter(d => appState.visibleMonths[d.month]);

            const datasets = appState.graphYears
                .filter(y => appState.visibleYears[y])
                .map((y, i) => {
                    const colors = ['#3b82f6', '#ef4444', '#22c55e', '#f97316', '#a855f7'];
                    return {
                        label: y.toString(),
                        data: data.map(d => d[y]),
                        borderColor: colors[i % colors.length],
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    };
                });

            const isMobile = window.innerWidth < 768;

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.label),
                    datasets: datasets
                },
                options: {
                    indexAxis: isMobile ? 'y' : 'x',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: isMobile ? 'bottom' : 'top'
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: appState.graphMetric === 'temp' ? 'Temperature (¬∞F)' : appState.graphMetric === 'daylight' ? 'Hours' : 'Snowfall (inches)'
                            }
                        }
                    }
                }
            });

            appState.chartInstance = chart;
        }

        // Handle window resize for mobile detection
        window.addEventListener('resize', () => {
            const newIsMobile = window.innerWidth < 768;
            if (newIsMobile !== appState.isMobile) {
                setState({ isMobile: newIsMobile });
            }
        });

        // Initial render
        fetchWeatherData();
        render();
    </script>
</body>
</html>
